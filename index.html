<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant Vocal de Maintenance</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configuration de PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #4c1d95;
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .subtitle {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .upload-zone {
            background: #eef2ff;
            border: 3px dashed #6366f1;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            background: #e0e7ff;
            border-color: #4f46e5;
        }

        .upload-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        #fileInput {
            display: none;
        }

        .mode-indicator {
            background: #dcfce7;
            border: 3px solid #22c55e;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
            display: none;
        }

        .mode-indicator.active {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .start-button {
            width: 100%;
            background: #22c55e;
            color: white;
            border: none;
            padding: 25px;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 15px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
            display: none;
        }

        .start-button.visible {
            display: block;
        }

        .start-button:hover {
            background: #16a34a;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(34, 197, 94, 0.3);
        }

        .status-box {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .status-box.visible {
            display: block;
        }

        .status-listening {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            animation: pulse 1.5s infinite;
        }

        .status-speaking {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }

        .transcript-box {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .transcript-box.visible {
            display: block;
        }

        .response-box {
            background: #dcfce7;
            border: 2px solid #22c55e;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .response-box.visible {
            display: block;
        }

        .history {
            margin-top: 30px;
        }

        .history-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #6366f1;
        }

        .timestamp {
            color: #9ca3af;
            font-size: 0.85em;
            margin-bottom: 8px;
        }

        .instructions {
            background: #f9fafb;
            padding: 25px;
            border-radius: 12px;
            margin-top: 30px;
        }

        .instructions h3 {
            color: #1f2937;
            margin-bottom: 15px;
        }

        .instructions ul {
            list-style: none;
            padding-left: 0;
        }

        .instructions li {
            padding: 8px 0;
            color: #4b5563;
            font-size: 1.05em;
        }

        .alert-box {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .alert-box h3 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .alert-box p {
            color: #78350f;
            line-height: 1.6;
        }

        .examples {
            background: #dbeafe;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .stop-command {
            background: #fee2e2;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        strong {
            color: #4c1d95;
        }

        .icon {
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span class="icon">üìÑ</span>
            Assistant Vocal de Maintenance
        </h1>
        <p class="subtitle">Chargez un PDF et posez vos questions vocalement - 100% mains libres</p>

        <!-- Alerte autorisation microphone -->
        <div class="alert-box">
            <h3>‚ö†Ô∏è IMPORTANT - Autorisation requise</h3>
            <p><strong>Pour que l'application fonctionne, vous devez autoriser le microphone :</strong></p>
            <p style="margin-top: 10px;">
                1Ô∏è‚É£ Cliquez sur l'ic√¥ne üîí ou üé§ dans la barre d'adresse (en haut √† gauche)<br>
                2Ô∏è‚É£ S√©lectionnez <strong>"Autoriser"</strong> pour le microphone<br>
                3Ô∏è‚É£ Si demand√©, rechargez la page (touche F5)
            </p>
            <p style="margin-top: 10px; font-weight: bold; color: #dc2626;">
                üîç Test du microphone : <span id="micTest">En attente...</span>
            </p>
        </div>

        <!-- Bouton de test microphone -->
        <button id="testMicButton" class="start-button visible" style="background: #f59e0b;">
            <span class="icon">üé§</span> TESTER LE MICROPHONE D'ABORD
        </button>

        <!-- Indicateur mode mains libres -->
        <div id="modeIndicator" class="mode-indicator">
            <h2 style="color: #16a34a; font-size: 1.8em;">üé§ MODE MAINS LIBRES ACTIF üé§</h2>
            <p style="color: #15803d; margin-top: 10px; font-size: 1.1em;">Je vous √©coute en continu - Parlez librement</p>
        </div>

        <!-- Zone de chargement PDF -->
        <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">üì§</div>
            <h3 id="fileName" style="color: #4c1d95; margin-bottom: 10px;">Charger un document PDF</h3>
            <p style="color: #6b7280;">Formats accept√©s : <strong>.pdf</strong> uniquement<br>
            Cliquez pour s√©lectionner votre document de maintenance</p>
            <input type="file" id="fileInput" accept=".pdf">
        </div>

        <!-- Bouton d√©marrage mode vocal -->
        <button id="startButton" class="start-button">
            <span class="icon">üé§</span> D√âMARRER LE MODE MAINS LIBRES
        </button>

        <!-- Indicateurs de statut -->
        <div id="listeningStatus" class="status-box status-listening">
            <h3 style="color: #1e40af;">üé§ Je vous √©coute... Parlez maintenant</h3>
        </div>

        <div id="speakingStatus" class="status-box status-speaking">
            <h3 style="color: #b45309;">üîä Assistant en train de parler...</h3>
        </div>

        <!-- Transcript -->
        <div id="transcriptBox" class="transcript-box">
            <p style="color: #1e40af; font-weight: bold; margin-bottom: 8px;">Votre question :</p>
            <p id="transcriptText" style="color: #1e3a8a;"></p>
        </div>

        <!-- R√©ponse -->
        <div id="responseBox" class="response-box">
            <p style="color: #15803d; font-weight: bold; margin-bottom: 8px;">R√©ponse :</p>
            <p id="responseText" style="color: #166534;"></p>
        </div>

        <!-- Historique -->
        <div id="history" class="history" style="display: none;">
            <h2 style="color: #4c1d95; margin-bottom: 15px;">üìã Historique</h2>
            <div id="historyItems"></div>
        </div>

        <!-- Instructions -->
        <div class="instructions">
            <h3>üìã Mode d'emploi :</h3>
            <ul>
                <li><strong>1.</strong> Testez d'abord le microphone avec le bouton orange</li>
                <li><strong>2.</strong> Chargez votre document PDF de maintenance (extension .pdf)</li>
                <li><strong>3.</strong> Cliquez sur "D√âMARRER LE MODE MAINS LIBRES"</li>
                <li><strong>4.</strong> Parlez naturellement - l'assistant vous √©coute en continu</li>
                <li><strong>5.</strong> Plus besoin de toucher l'√©cran ensuite !</li>
            </ul>
            
            <div class="examples">
                <p style="color: #1e40af; font-weight: bold; margin-bottom: 8px;">üí¨ Commandes vocales disponibles :</p>
                <p style="color: #1e3a8a; font-size: 0.9em; line-height: 1.8;">
                    <strong>Navigation :</strong><br>
                    ‚Ä¢ "Sommaire" ou "Table des mati√®res"<br>
                    ‚Ä¢ "Page 25" (aller √† une page sp√©cifique)<br>
                    ‚Ä¢ "Combien de pages ?"<br>
                    ‚Ä¢ "Aller √† la section 3"<br><br>
                    
                    <strong>Recherche :</strong><br>
                    ‚Ä¢ "Chercher maintenance pr√©ventive"<br>
                    ‚Ä¢ "Trouve le mot pression"<br>
                    ‚Ä¢ "Quelle est la proc√©dure ?"<br>
                    ‚Ä¢ "Quels sont les outils ?"<br>
                    ‚Ä¢ "Consignes de s√©curit√© ?"<br><br>
                    
                    <strong>Lecture :</strong><br>
                    ‚Ä¢ "Lire le document"<br>
                    ‚Ä¢ "Continue" ou "Suite"<br>
                    ‚Ä¢ "Aide" (liste des commandes)
                </p>
            </div>
            
            <div class="stop-command">
                <p style="color: #991b1b; font-size: 0.9em;">
                    <strong>Pour arr√™ter :</strong> Dites "stop" ou "d√©sactive" vocalement
                </p>
            </div>
        </div>
    </div>

    <script>
        let pdfText = '';
        let autoListenEnabled = false;
        let recognition = null;
        let speechSynthesis = window.speechSynthesis;
        let conversationHistory = [];
        let microphoneAuthorized = false;
        let pdfPages = []; // Stockage page par page
        let pdfSummary = []; // Sommaire extrait
        let currentSection = null; // Section actuelle

        // TEST DU MICROPHONE AU CHARGEMENT
        window.addEventListener('load', function() {
            console.log('üöÄ Application charg√©e - Maint-Vox v1.0');
            checkMicrophoneSupport();
        });

        function checkMicrophoneSupport() {
            const micTestElement = document.getElementById('micTest');
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                micTestElement.textContent = '‚ùå Reconnaissance vocale non support√©e';
                micTestElement.style.color = '#dc2626';
                console.error('‚ùå Reconnaissance vocale non support√©e par ce navigateur');
                alert('‚ö†Ô∏è Votre navigateur ne supporte pas la reconnaissance vocale.\n\nUtilisez Chrome, Edge ou Safari.');
                return;
            }
            
            micTestElement.textContent = '‚úÖ API de reconnaissance vocale d√©tect√©e';
            micTestElement.style.color = '#16a34a';
            console.log('‚úÖ API de reconnaissance vocale disponible');
        }

        // BOUTON TEST MICROPHONE
        document.getElementById('testMicButton').addEventListener('click', async function() {
            console.log('üé§ Test du microphone demand√©...');
            const micTestElement = document.getElementById('micTest');
            
            try {
                micTestElement.textContent = '‚è≥ Test en cours...';
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                console.log('‚úÖ Acc√®s au microphone accord√©');
                micTestElement.textContent = '‚úÖ MICROPHONE AUTORIS√â ET FONCTIONNEL !';
                micTestElement.style.color = '#16a34a';
                microphoneAuthorized = true;
                
                // Arr√™ter le stream de test
                stream.getTracks().forEach(track => track.stop());
                
                // Message vocal de confirmation
                speakText('Microphone autoris√© avec succ√®s ! Vous pouvez maintenant charger un document PDF.');
                
                // Cacher le bouton de test
                document.getElementById('testMicButton').style.display = 'none';
                
            } catch (error) {
                console.error('‚ùå Erreur microphone:', error);
                micTestElement.textContent = '‚ùå MICROPHONE BLOQU√â';
                micTestElement.style.color = '#dc2626';
                
                alert('‚ö†Ô∏è ACC√àS AU MICROPHONE REFUS√â ‚ö†Ô∏è\n\n' +
                      'Le navigateur a bloqu√© l\'acc√®s au microphone.\n\n' +
                      'Solutions :\n' +
                      '1. Cliquez sur l\'ic√¥ne üîí dans la barre d\'adresse\n' +
                      '2. Cherchez "Microphone" et cliquez sur "Autoriser"\n' +
                      '3. Rechargez la page (F5)\n' +
                      '4. Cliquez √† nouveau sur "TESTER LE MICROPHONE"\n\n' +
                      'D√©tails de l\'erreur : ' + error.message);
            }
        });

        // Initialisation de la reconnaissance vocale
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'fr-FR';
            
            console.log('‚úÖ Reconnaissance vocale initialis√©e (WebKit)');

            recognition.onstart = function() {
                console.log('üé§ Reconnaissance d√©marr√©e - √âCOUTE EN COURS');
                showListeningStatus();
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                const confidence = event.results[0][0].confidence;
                console.log('‚úÖ Transcript re√ßu:', transcript, '| Confiance:', (confidence * 100).toFixed(0) + '%');
                showTranscript(transcript);
                handleVoiceQuery(transcript);
            };

            recognition.onerror = function(event) {
                console.error('‚ùå Erreur reconnaissance:', event.error);
                hideListeningStatus();
                
                if (event.error === 'not-allowed' || event.error === 'permission-denied') {
                    autoListenEnabled = false;
                    document.getElementById('modeIndicator').classList.remove('active');
                    alert('‚ö†Ô∏è MICROPHONE BLOQU√â ‚ö†Ô∏è\n\n' +
                          'Le microphone est bloqu√© par votre navigateur.\n\n' +
                          '1. Cliquez sur l\'ic√¥ne üîí dans la barre d\'adresse\n' +
                          '2. Cherchez "Microphone" et s√©lectionnez "Autoriser"\n' +
                          '3. Rechargez la page (F5)');
                } else if (event.error === 'no-speech') {
                    console.log('‚ö†Ô∏è Aucune parole d√©tect√©e, relance automatique...');
                    showResponse('Je n\'ai rien entendu. Parlez plus fort ou plus pr√®s du microphone.');
                } else if (event.error === 'audio-capture') {
                    alert('‚ùå ERREUR MICROPHONE\n\nLe microphone n\'est pas d√©tect√© ou est utilis√© par une autre application.');
                } else {
                    console.error('Erreur inconnue:', event.error);
                    showResponse('Erreur de reconnaissance vocale : ' + event.error);
                }
            };

            recognition.onend = function() {
                console.log('‚èπÔ∏è Reconnaissance termin√©e');
                hideListeningStatus();
                if (autoListenEnabled && !speechSynthesis.speaking) {
                    setTimeout(() => {
                        if (autoListenEnabled) {
                            console.log('üîÑ Relance automatique de l\'√©coute...');
                            try {
                                recognition.start();
                                showListeningStatus();
                            } catch (e) {
                                console.error('Erreur relance:', e);
                            }
                        }
                    }, 1000);
                }
            };
        } else if ('SpeechRecognition' in window) {
            recognition = new SpeechRecognition();
            console.log('‚úÖ Reconnaissance vocale standard initialis√©e');
        } else {
            console.error('‚ùå Reconnaissance vocale non support√©e');
            alert('‚ö†Ô∏è Votre navigateur ne supporte pas la reconnaissance vocale.\n\nUtilisez Chrome, Edge ou Safari.');
        }

        // Gestion du fichier PDF
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file || file.type !== 'application/pdf') {
                speakText('Veuillez s√©lectionner un fichier PDF valide');
                return;
            }

            console.log('üìÑ Chargement du PDF:', file.name);
            document.getElementById('fileName').textContent = file.name + ' - Extraction en cours...';
            speakText('Chargement du document en cours');

            try {
                const arrayBuffer = await file.arrayBuffer();
                pdfText = await extractTextFromPDF(arrayBuffer);
                
                console.log('‚úÖ PDF charg√©, texte extrait (' + pdfText.length + ' caract√®res)');
                console.log('Aper√ßu:', pdfText.substring(0, 200));
                
                document.getElementById('fileName').textContent = file.name + ' ‚úÖ';
                
                const successMsg = `Document ${file.name} charg√© avec succ√®s. ${Math.floor(pdfText.length / 100)} lignes extraites. Je suis pr√™t √† r√©pondre √† vos questions.`;
                showResponse(successMsg);
                speakText(successMsg);
                
                document.getElementById('startButton').classList.add('visible');
            } catch (error) {
                console.error('‚ùå Erreur PDF:', error);
                const errorMsg = 'Erreur lors du chargement du PDF: ' + error.message;
                showResponse(errorMsg);
                speakText(errorMsg);
            }
        });

        // Extraction du texte du PDF avec PDF.js
        async function extractTextFromPDF(arrayBuffer) {
            console.log('üìñ Extraction du texte avec PDF.js...');
            
            try {
                const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
                const pdf = await loadingTask.promise;
                
                console.log('üìÑ PDF charg√©:', pdf.numPages, 'pages');
                
                let fullText = '';
                pdfPages = []; // R√©initialiser
                
                // Extraire le texte de chaque page
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    
                    const pageText = textContent.items
                        .map(item => item.str)
                        .join(' ');
                    
                    // Stocker chaque page s√©par√©ment
                    pdfPages.push({
                        number: pageNum,
                        text: pageText.trim()
                    });
                    
                    fullText += pageText + '\n\n';
                    
                    if (pageNum % 10 === 0) {
                        console.log(`‚úÖ ${pageNum}/${pdf.numPages} pages extraites...`);
                    }
                }
                
                // Nettoyer le texte
                fullText = fullText
                    .replace(/\s+/g, ' ')
                    .trim();
                
                // Extraire le sommaire automatiquement
                pdfSummary = extractSummary(fullText);
                console.log('üìë Sommaire extrait:', pdfSummary.length, 'sections trouv√©es');
                
                if (!fullText || fullText.length < 20) {
                    throw new Error('Le PDF semble vide ou le texte n\'a pas pu √™tre extrait');
                }
                
                console.log('‚úÖ Extraction termin√©e:', fullText.length, 'caract√®res,', pdf.numPages, 'pages');
                return fullText;
                
            } catch (error) {
                console.error('‚ùå Erreur extraction PDF.js:', error);
                throw new Error('Impossible d\'extraire le texte du PDF. Le document est peut-√™tre prot√©g√© ou contient uniquement des images.');
            }
        }

        // Extraire le sommaire du document
        function extractSummary(text) {
            const summary = [];
            
            // Rechercher les patterns de titre/section
            const patterns = [
                /(?:^|\n)(CHAPITRE|SECTION|PARTIE)\s+(\d+|[IVX]+)[:\s\-]+([^\n]{10,100})/gi,
                /(?:^|\n)(\d+[\.\)]\s+[A-Z√Ä√â√à√ä][^\n]{10,100})/g,
                /(?:^|\n)([A-Z√Ä√â√à√ä][A-Z√Ä√â√à√ä\s]{5,50})\s*\n/g,
                /(?:^|\n)(Introduction|Conclusion|Proc√©dure|S√©curit√©|Outils|Mat√©riel|√âtapes|Instructions)[:\s\-]+([^\n]{0,80})/gi
            ];
            
            patterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const title = match[0].trim();
                    const position = match.index;
                    
                    // √âviter les doublons
                    if (!summary.some(s => s.title === title)) {
                        summary.push({
                            title: title,
                            position: position,
                            page: findPageForPosition(position)
                        });
                    }
                }
            });
            
            // Trier par position
            summary.sort((a, b) => a.position - b.position);
            
            return summary.slice(0, 50); // Limiter √† 50 sections
        }

        // Trouver la page correspondant √† une position dans le texte
        function findPageForPosition(position) {
            let currentPos = 0;
            for (let i = 0; i < pdfPages.length; i++) {
                currentPos += pdfPages[i].text.length;
                if (currentPos >= position) {
                    return i + 1;
                }
            }
            return pdfPages.length;
        }

        // Rechercher dans une plage de pages
        function searchInPages(query, startPage = 1, endPage = null) {
            endPage = endPage || pdfPages.length;
            const results = [];
            const searchTerms = query.toLowerCase().split(' ').filter(w => w.length > 2);
            
            for (let i = startPage - 1; i < endPage && i < pdfPages.length; i++) {
                const pageText = pdfPages[i].text;
                const pageTextLower = pageText.toLowerCase();
                
                // Chercher chaque terme
                for (const term of searchTerms) {
                    const index = pageTextLower.indexOf(term);
                    if (index !== -1) {
                        // Extraire le contexte autour du mot-cl√© (plus large)
                        const start = Math.max(0, index - 150);
                        const end = Math.min(pageText.length, index + 300);
                        let context = pageText.substring(start, end).trim();
                        
                        // Nettoyer le contexte
                        context = context.replace(/\s+/g, ' ');
                        
                        // √âviter les doublons de la m√™me page
                        if (!results.some(r => r.page === i + 1)) {
                            results.push({
                                page: i + 1,
                                context: context,
                                fullPageText: pageText
                            });
                        }
                        break; // Passer √† la page suivante apr√®s avoir trouv√© un r√©sultat
                    }
                }
            }
            
            return results;
        }
        
        // Nouvelle fonction : extraction intelligente d'information
        function extractRelevantInfo(query, fullText) {
            const lowerQuery = query.toLowerCase();
            const lowerText = fullText.toLowerCase();
            
            // Trouver la position de la requ√™te
            const queryIndex = lowerText.indexOf(lowerQuery);
            if (queryIndex === -1) return null;
            
            // Extraire un large contexte
            const start = Math.max(0, queryIndex - 200);
            const end = Math.min(fullText.length, queryIndex + 500);
            
            return fullText.substring(start, end).replace(/\s+/g, ' ').trim();
        }

        // D√©marrage du mode mains libres
        document.getElementById('startButton').addEventListener('click', async function() {
            console.log('üöÄ Tentative de d√©marrage du mode mains libres...');
            
            if (!microphoneAuthorized) {
                alert('‚ö†Ô∏è VEUILLEZ D\'ABORD TESTER LE MICROPHONE\n\nCliquez sur le bouton orange "TESTER LE MICROPHONE D\'ABORD" pour autoriser l\'acc√®s.');
                return;
            }
            
            if (!pdfText) {
                alert('‚ö†Ô∏è Aucun document PDF charg√©');
                return;
            }
            
            try {
                console.log('üìã V√©rification finale des permissions...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                console.log('‚úÖ Permissions confirm√©es');
                
                autoListenEnabled = true;
                document.getElementById('modeIndicator').classList.add('active');
                speakText('Mode mains libres activ√©. Je vous √©coute maintenant.');
                
                setTimeout(() => {
                    if (recognition) {
                        try {
                            console.log('üé§ D√©marrage de la reconnaissance vocale...');
                            recognition.start();
                            showListeningStatus();
                            console.log('‚úÖ Reconnaissance d√©marr√©e avec succ√®s');
                        } catch (error) {
                            console.error('‚ùå Erreur d√©marrage reconnaissance:', error);
                            alert('Erreur lors du d√©marrage: ' + error.message);
                        }
                    }
                }, 2500);
            } catch (error) {
                console.error('‚ùå Erreur permissions:', error);
                alert('‚ö†Ô∏è Erreur d\'autorisation: ' + error.message);
            }
        });

        // Gestion des questions vocales
        function handleVoiceQuery(query) {
            if (!pdfText) {
                const errorMsg = 'Veuillez d\'abord charger un fichier PDF';
                showResponse(errorMsg);
                speakText(errorMsg);
                return;
            }

            const answer = generateAnswer(query, pdfText);
            showResponse(answer);
            
            conversationHistory.push({
                question: query,
                answer: answer,
                timestamp: new Date().toLocaleTimeString('fr-FR')
            });
            
            updateHistory();
            speakText(answer);
        }

        // G√©n√©ration des r√©ponses avec navigation intelligente
        function generateAnswer(query, content) {
            const lowerQuery = query.toLowerCase();

            // Commandes de contr√¥le
            if (lowerQuery.includes('d√©sactiv') || lowerQuery.includes('stop') || lowerQuery.includes('arr√™t')) {
                autoListenEnabled = false;
                document.getElementById('modeIndicator').classList.remove('active');
                if (recognition) recognition.stop();
                return 'Mode mains libres d√©sactiv√©.';
            }

            // Commandes de navigation
            if (lowerQuery.includes('sommaire') || lowerQuery.includes('table des mati√®res') || lowerQuery.includes('chapitres')) {
                if (pdfSummary.length === 0) {
                    return 'Aucun sommaire d√©tect√© automatiquement. Le document contient ' + pdfPages.length + ' pages. Utilisez "chercher" suivi d\'un mot-cl√© pour trouver une section.';
                }
                
                const summaryText = pdfSummary.slice(0, 10).map((s, i) => 
                    `Section ${i + 1}: ${s.title}, page ${s.page}`
                ).join('. ');
                
                return `Voici le sommaire avec ${pdfSummary.length} sections principales. ${summaryText}. Dites "aller √† la section" suivi du num√©ro pour naviguer.`;
            }

            // Navigation par num√©ro de page
            const pageMatch = lowerQuery.match(/(?:page|pages)\s+(\d+)/);
            if (pageMatch) {
                const pageNum = parseInt(pageMatch[1]);
                if (pageNum > 0 && pageNum <= pdfPages.length) {
                    const pageContent = pdfPages[pageNum - 1].text.substring(0, 400);
                    return `Page ${pageNum} : ${pageContent}... Voulez-vous que je continue ?`;
                }
                return `Le document contient ${pdfPages.length} pages. La page ${pageNum} n'existe pas.`;
            }

            // Aller √† une section
            const sectionMatch = lowerQuery.match(/(?:section|chapitre)\s+(\d+)/);
            if (sectionMatch || lowerQuery.includes('aller √†')) {
                const sectionNum = sectionMatch ? parseInt(sectionMatch[1]) - 1 : 0;
                if (pdfSummary[sectionNum]) {
                    currentSection = pdfSummary[sectionNum];
                    const sectionContent = content.substring(
                        currentSection.position, 
                        currentSection.position + 500
                    );
                    return `${currentSection.title}. Contenu : ${sectionContent}... Voulez-vous que je continue cette section ?`;
                }
                return 'Section non trouv√©e. Dites "sommaire" pour voir les sections disponibles.';
            }

            // Recherche par mot-cl√©
            if (lowerQuery.includes('cherche') || lowerQuery.includes('chercher') || lowerQuery.includes('trouve') || lowerQuery.includes('trouver')) {
                const searchTerms = lowerQuery
                    .replace(/cherche|chercher|trouve|trouver|le|la|les|un|une|des/gi, '')
                    .trim();
                
                if (searchTerms.length > 2) {
                    const results = searchInPages(searchTerms);
                    if (results.length > 0) {
                        const firstResult = results[0];
                        const otherPages = results.slice(1, 4).map(r => r.page).join(', ');
                        return `J'ai trouv√© "${searchTerms}" √† la page ${firstResult.page}. Contexte : ${firstResult.context}... ${results.length > 1 ? `Aussi trouv√© pages ${otherPages}.` : ''}`;
                    }
                    return `Je n'ai pas trouv√© "${searchTerms}" dans le document de ${pdfPages.length} pages.`;
                }
            }

            // Informations sur le document
            if (lowerQuery.includes('combien de pages') || lowerQuery.includes('nombre de pages')) {
                return `Le document contient ${pdfPages.length} pages. Dites "sommaire" pour voir la structure, ou "chercher" suivi d'un mot-cl√© pour trouver une information.`;
            }

            // Proc√©dure
            if (lowerQuery.includes('proc√©dure') || lowerQuery.includes('comment') || lowerQuery.includes('√©tape')) {
                console.log('üîç Recherche proc√©dure...');
                
                // Chercher plusieurs variantes
                let results = searchInPages('proc√©dure');
                if (results.length === 0) results = searchInPages('√©tape');
                if (results.length === 0) results = searchInPages('instruction');
                if (results.length === 0) results = searchInPages('mode op√©ratoire');
                
                if (results.length > 0) {
                    console.log('‚úÖ Trouv√©:', results.length, 'r√©sultats');
                    const info = results[0];
                    return `Proc√©dure trouv√©e page ${info.page}. Voici l'extrait : ${info.context}. Dites "page ${info.page}" pour plus de d√©tails ou "suite" pour continuer.`;
                }
                
                console.log('‚ö†Ô∏è Proc√©dure non trouv√©e, recherche large...');
                // Si rien trouv√©, lire les premi√®res pages (souvent le contenu principal)
                if (pdfPages.length > 1) {
                    const page2Content = pdfPages[1].text.substring(0, 400);
                    return `Voici le contenu de la page 2 qui contient g√©n√©ralement les proc√©dures : ${page2Content}. Voulez-vous que je continue ?`;
                }
                return 'Proc√©dure non trouv√©e. Dites "chercher" suivi d\'un mot-cl√© plus pr√©cis, ou "page 2" pour lire une page sp√©cifique.';
            }

            // S√©curit√©  
            if (lowerQuery.includes('s√©curit√©') || lowerQuery.includes('danger') || lowerQuery.includes('risque') || lowerQuery.includes('protection')) {
                console.log('üîç Recherche s√©curit√©...');
                
                let results = searchInPages('s√©curit√©');
                if (results.length === 0) results = searchInPages('protection');
                if (results.length === 0) results = searchInPages('danger');
                if (results.length === 0) results = searchInPages('epi');
                
                if (results.length > 0) {
                    console.log('‚úÖ Trouv√© s√©curit√©');
                    return `S√©curit√©, page ${results[0].page} : ${results[0].context}`;
                }
                return 'Consignes g√©n√©rales : Portez vos EPI. Coupez l\'alimentation. Aucune mention sp√©cifique trouv√©e dans ce document.';
            }

            // Outils
            if (lowerQuery.includes('outil') || lowerQuery.includes('mat√©riel') || lowerQuery.includes('√©quipement')) {
                console.log('üîç Recherche outils...');
                
                let results = searchInPages('outil');
                if (results.length === 0) results = searchInPages('mat√©riel');
                if (results.length === 0) results = searchInPages('√©quipement');
                
                if (results.length > 0) {
                    console.log('‚úÖ Trouv√© outils');
                    return `Outils/mat√©riel page ${results[0].page} : ${results[0].context}`;
                }
                return 'Liste d\'outils non trouv√©e dans ce document. Il s\'agit peut-√™tre d\'un document administratif.';
            }

            // Lecture compl√®te ou continuation
            if (lowerQuery.includes('lire') || lowerQuery.includes('continue') || lowerQuery.includes('suite')) {
                if (currentSection) {
                    const sectionContent = content.substring(
                        currentSection.position, 
                        currentSection.position + 1000
                    );
                    return `Suite de ${currentSection.title} : ${sectionContent}`;
                }
                
                // Lire le d√©but du document
                const preview = pdfPages[0].text.substring(0, 500);
                return `D√©but du document de ${pdfPages.length} pages : ${preview}... Dites "suite" pour continuer ou "page" suivi d'un num√©ro pour aller √† une page sp√©cifique.`;
            }

            // Aide
            if (lowerQuery.includes('aide') || lowerQuery.includes('commandes') || lowerQuery.includes('comment faire')) {
                return 'Commandes disponibles : "sommaire" pour voir la structure. "page" suivi d\'un num√©ro. "chercher" suivi d\'un mot-cl√©. "proc√©dure", "s√©curit√©", "outils". "combien de pages". Document de ' + pdfPages.length + ' pages charg√©.';
            }

            // R√©ponse par d√©faut - recherche contextuelle am√©lior√©e
            console.log('üîç Recherche g√©n√©rique pour:', query);
            
            // Extraire les mots significatifs (plus de 3 lettres)
            const words = lowerQuery
                .replace(/[^\w√†√¢√§√©√®√™√´√Ø√Æ√¥√π√ª√º√ø√¶≈ì√ß]/g, ' ')
                .split(' ')
                .filter(w => w.length > 3);
            
            console.log('Mots-cl√©s extraits:', words);
            
            if (words.length > 0) {
                // Essayer chaque mot
                for (const word of words) {
                    const results = searchInPages(word);
                    if (results.length > 0) {
                        console.log('‚úÖ Trouv√© avec le mot:', word);
                        const otherPages = results.slice(1, 3).map(r => `page ${r.page}`).join(', ');
                        const moreInfo = results.length > 1 ? ` Aussi trouv√© ${otherPages}.` : '';
                        return `J'ai trouv√© "${word}" page ${results[0].page}. Voici l'extrait : ${results[0].context}.${moreInfo} Voulez-vous plus d'informations ?`;
                    }
                }
                
                console.log('‚ö†Ô∏è Aucun r√©sultat trouv√© pour les mots-cl√©s');
            }

            // Si vraiment rien trouv√©, proposer le sommaire ou page 1
            return `Je n'ai pas trouv√© "${query}" dans le document de ${pdfPages.length} pages. Essayez "sommaire" pour voir la structure, ou "page 1" pour lire depuis le d√©but. Vous pouvez aussi dire "aide" pour voir toutes les commandes.`;
        }

        // Synth√®se vocale
        function speakText(text) {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fr-FR';
            utterance.rate = 0.9;
            utterance.pitch = 1;

            utterance.onstart = function() {
                showSpeakingStatus();
            };

            utterance.onend = function() {
                hideSpeakingStatus();
                if (autoListenEnabled && recognition) {
                    setTimeout(() => {
                        recognition.start();
                        showListeningStatus();
                    }, 500);
                }
            };

            speechSynthesis.speak(utterance);
        }

        // Fonctions d'affichage
        function showTranscript(text) {
            document.getElementById('transcriptText').textContent = text;
            document.getElementById('transcriptBox').classList.add('visible');
        }

        function showResponse(text) {
            document.getElementById('responseText').textContent = text;
            document.getElementById('responseBox').classList.add('visible');
        }

        function showListeningStatus() {
            document.getElementById('listeningStatus').classList.add('visible');
        }

        function hideListeningStatus() {
            document.getElementById('listeningStatus').classList.remove('visible');
        }

        function showSpeakingStatus() {
            document.getElementById('speakingStatus').classList.add('visible');
        }

        function hideSpeakingStatus() {
            document.getElementById('speakingStatus').classList.remove('visible');
        }

        function updateHistory() {
            const historyDiv = document.getElementById('history');
            const historyItems = document.getElementById('historyItems');
            
            historyDiv.style.display = 'block';
            historyItems.innerHTML = '';
            
            conversationHistory.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'history-item';
                itemDiv.innerHTML = `
                    <div class="timestamp">${item.timestamp}</div>
                    <p style="color: #374151; margin-bottom: 8px;"><strong>Q:</strong> ${item.question}</p>
                    <p style="color: #4b5563;"><strong>R:</strong> ${item.answer}</p>
                `;
                historyItems.appendChild(itemDiv);
            });
        }
    </script>
</body>
</html>
